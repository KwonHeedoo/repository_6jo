<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.scit6jo.web.admin.dao.DashboardMapper">
	<!-- 방문자 & 가입자 수 요청(주 별, 월 별) -->
	<select id="countByJoinVisit" parameterType="string" resultType="GraphData">
		select 
			v.day as day, v.count as countOne, j.count as countTwo
		from
			(select 
				d.regdate as day, nvl(vi.count, 0) as count
			from 
			<if test="period == 'week'"> 
				(select 
					to_char(regdate, 'YYYY-MM-DD') as regdate, count(userid) as count 
				from 
					visitor 
				group by 
					to_char(regdate, 'YYYY-MM-DD')) vi
			right outer join
				(select 
					to_char((sysdate-6)+level-1, 'YYYY-MM-DD') as regdate 
				from 
					dual 
				connect by 
					level <![CDATA[<=]]> (sysdate - (sysdate-6)+1)) d
			on 
				vi.regdate = d.regdate
			order by 
				d.regdate) 
			</if>
			<if test="period == 'month'"> 
				(select 
					to_char(regdate, 'YYYY-MM') as regdate, count(userid) as count 
				from 
					visitor 
				where 
					to_char(regdate, 'YYYY') = to_char(sysdate, 'YYYY') 
				group by 
					to_char(regdate, 'YYYY-MM')) vi 
			right outer join 
				(select 
					to_char(add_months(trunc(sysdate,'Y'),level-1), 'YYYY-MM') as regdate 
				from 
					dual 
				connect by 
					level <![CDATA[<=]]> 12) d 
			on 
				vi.regdate = d.regdate 
			order by 
				d.regdate) 
			</if>
			v, 
			(select 
				d.regdate as day, nvl(jo.count, 0) as count
			from
			<if test="period == 'week'"> 
				(select 
					to_char(regdate, 'YYYY-MM-DD') as regdate, count(userid) as count 
				from 
					userlist 
				group by 
					to_char(regdate, 'YYYY-MM-DD')) jo
			right outer join
				(select 
					to_char((sysdate-6)+level-1, 'YYYY-MM-DD') as regdate 
				from 
					dual 
				connect by 
					level <![CDATA[<=]]> (sysdate - (sysdate-6)+1)) d
			on 
				jo.regdate = d.regdate
			order by 
				d.regdate) 
			</if>
			<if test="period == 'month'">
				(select 
					to_char(regdate, 'YYYY-MM') as regdate, count(userid) as count 
				from 
					userlist 
				where 
					to_char(regdate, 'YYYY') = to_char(sysdate, 'YYYY') 
				group by 
					to_char(regdate, 'YYYY-MM')) jo 
			right outer join 
				(select 
					to_char(add_months(trunc(sysdate,'Y'),level-1), 'YYYY-MM') as regdate 
				from 
					dual 
				connect by 
					level <![CDATA[<=]]> 12) d 
			on 
				jo.regdate = d.regdate 
			order by 
				d.regdate) 
			</if>
			j 
		where 
			v.day = j.day
	</select>
	
	<!-- 신고 & 재제 수 요청(주 별, 월 별) -->
	<select id="countByRptSanc" parameterType="string" resultType="GraphData">
		select 
			r.day as day, r.count as countOne, s.count as countTwo
		from
			(select 
				d.regdate as day, nvl(rp.count, 0) as count 
			from 
			<if test="period == 'week'">
				(select 
					to_char(regdate, 'YYYY-MM-DD') as regdate, count(reportee) as count 
				from 
					report 
				group by 
					to_char(regdate, 'YYYY-MM-DD')) rp 
			right outer join 
				(select 
					to_char((sysdate-6)+level-1, 'YYYY-MM-DD') as regdate 
				from 
					dual 
				connect by 
					level <![CDATA[<=]]> (sysdate - (sysdate-6)+1)) d 
			on 
				rp.regdate = d.regdate 
			order by 
				d.regdate) 
			</if>
			<if test="period == 'month'">
				(select 
					to_char(regdate, 'YYYY-MM') as regdate, count(reportee) as count 
				from 
					report 
				where 
					to_char(regdate, 'YYYY') = to_char(sysdate, 'YYYY') 
				group by 
					to_char(regdate, 'YYYY-MM')) rp 
			right outer join 
				(select 
					to_char(add_months(trunc(sysdate,'Y'),level-1), 'YYYY-MM') as regdate 
				from 
					dual 
				connect by 
					level <![CDATA[<=]]> 12) d 
			on 
				rp.regdate = d.regdate 
			order by 
				d.regdate) 
			</if>
			r,
			(select 
				d.regdate as day, nvl(st.count, 0) as count 
			from 
			<if test="period == 'week'"> 
				(select 
					to_char(starttime, 'YYYY-MM-DD') as regdate, count(userid) as count 
				from 
					sanction 
				group by 
					to_char(starttime, 'YYYY-MM-DD')) st 
			right outer join 
				(select 
					to_char((sysdate-6)+level-1, 'YYYY-MM-DD') as regdate 
				from 
					dual 
				connect by 
					level <![CDATA[<=]]> (sysdate - (sysdate-6)+1)) d 
			on 
				st.regdate = d.regdate 
			order by 
				d.regdate) 
			</if>
			<if test="period == 'month'"> 
				(select 
					to_char(starttime, 'YYYY-MM') as regdate, count(userid) as count 
				from 
					sanction 
				where 
					to_char(starttime, 'YYYY') = to_char(sysdate, 'YYYY') 
				group by 
					to_char(starttime, 'YYYY-MM')) st 
			right outer join 
				(select 
					to_char(add_months(trunc(sysdate,'Y'),level-1), 'YYYY-MM') as regdate 
				from 
					dual 
				connect by 
					level <![CDATA[<=]]> 12) d 
			on 
				st.regdate = d.regdate 
			order by 
				d.regdate) 
			</if>
			s
		where 
			r.day = s.day
	</select>
	
	<!-- 회원 연령대 별 인원수 요청 -->
	<select id="countByUserAge" resultType="GraphData">
		select 
			sum(decode(abs(age - 10) + abs(age - 19), 9, 1, 0)) as countOne
			, sum(decode(abs(age - 20) + abs(age - 29), 9, 1, 0)) as countTwo
			, sum(decode(abs(age - 30) + abs(age - 39), 9, 1, 0)) as countThree
			, sum(decode(sign(age - 40), 1, 1, 0, 1, 0)) as countFour  
		from 
			(select 
				floor(months_between(sysdate, birthdate) / 12) as age 
			from 
				userlist)
	</select>
	
	<!-- 오늘의 게시물 수 -->
	<select id="countByBoard" resultType="int">
		select 
			sum(a + b) as count 
		from 
			(select 
				count(*) a 
			from 
				matching_board 
			where 
				to_char(regdate, 'yyyy-mm-dd') = to_char(sysdate, 'yyyy-mm-dd')), 
			(select 
				count(*) b 
			from 
			<!-- 평가 게시물로 바꿔야함 -->
				notice_board 
			where 
				to_char(regdate, 'yyyy-mm-dd') = to_char(sysdate, 'yyyy-mm-dd'))
	</select>
</mapper>
